name: Build

on:
  workflow_call:

jobs:
  build:
    name: duckdb ${{ matrix.duckdb_version }} Ã— pyodide ${{ matrix.pyodide_version }} (py${{ matrix.python_version }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - duckdb_version: 'v1.4.4'
            pyodide_version: '0.29.3'
            python_version: '3.13'

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v6

      - name: Set derived variables
        id: vars
        run: |
          PYODIDE_VERSION="${{ matrix.pyodide_version }}"
          XBUILDENV_URL="https://github.com/pyodide/pyodide/releases/download/${PYODIDE_VERSION}/xbuildenv-${PYODIDE_VERSION}.tar.bz2"
          echo "xbuildenv_url=${XBUILDENV_URL}" >> "$GITHUB_OUTPUT"

      - name: Clone duckdb-python with submodules
        run: |
          DUCKDB_REF="${{ matrix.duckdb_version }}"

          # Full clone so setuptools_scm can find git tags for versioning
          git clone \
            --recurse-submodules \
            --shallow-submodules \
            https://github.com/duckdb/duckdb-python.git \
            duckdb-python
          git -C duckdb-python checkout "$DUCKDB_REF"
          git -C duckdb-python submodule update --init --recursive

      - name: Show duckdb-python version
        run: |
          cd duckdb-python
          git log -1 --format='%H %s'
          git describe --tags --always 2>/dev/null || true

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python_version }}

      - name: Install pyodide-build
        run: |
          pip install "pyodide-build==${{ matrix.pyodide_version }}" "wheel<0.44" --pre

      - name: Get emscripten version
        id: emscripten
        run: |
          version=$(pyodide config get emscripten_version)
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "Emscripten version: ${version}"

      - name: Setup emsdk
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: ${{ steps.emscripten.outputs.version }}

      - name: Patch CMakeLists.txt
        run: python3 ${{ github.workspace }}/scripts/patch_cmake.py
        working-directory: duckdb-python

      - name: Build WASM wheel
        working-directory: duckdb-python
        env:
          # DUCKDB_CUSTOM_PLATFORM (env) only affects the wheel filename tag.
          # DUCKDB_EXPLICIT_PLATFORM (CMake) bakes the platform string into the binary,
          # which is what PRAGMA platform returns at runtime. Without this,
          # PRAGMA platform returns the host platform (e.g. linux_i686_musl).
          DUCKDB_CUSTOM_PLATFORM: wasm_eh_pyodide
          CMAKE_ARGS: "-DDUCKDB_EXPLICIT_PLATFORM=wasm_eh_pyodide"
          CFLAGS: "-fwasm-exceptions"
          LDFLAGS: "-fwasm-exceptions"
          DEFAULT_CROSS_BUILD_ENV_URL: ${{ steps.vars.outputs.xbuildenv_url }}
          # Our patch to CMakeLists.txt dirties the working tree, so setuptools_scm
          # sees distance=0 + dirty and can't determine the version. Override it directly.
          OVERRIDE_GIT_DESCRIBE: ${{ matrix.duckdb_version }}
        run: |
          pyodide build --exports=whole_archive

      - name: Show wheel info
        run: ls -lah duckdb-python/dist/*.whl

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v6
        with:
          name: duckdb-${{ matrix.duckdb_version }}-pyodide-${{ matrix.pyodide_version }}
          if-no-files-found: error
          path: duckdb-python/dist/*.whl
          retention-days: 90
